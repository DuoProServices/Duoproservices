import{s as g,A as S,j as e}from"./index-B2LFkxWB.js";import{u as T,r as x}from"./vendor-Cq0Q7ve9.js";import{t as _,w as K,m as V,F as M,c as D,a3 as R,ae as B,j as q,M as z,P as J,Z}from"./ui-VDfBvwns.js";import"./supabase-C9VFef86.js";function X(){const F=T(),[h,u]=x.useState([]),[E,b]=x.useState(!0),[p,P]=x.useState(""),[f,I]=x.useState("all"),[L,N]=x.useState(!1);x.useEffect(()=>{$()},[]);const $=async()=>{var s;b(!0);try{const{data:l,error:o}=await g.auth.getSession();if(o||!l.session)throw console.error("âŒ [ClientsModule] Auth error:",o),new Error("Not authenticated");try{console.log("âœ… [ClientsModule] Auth OK, fetching from:",S.adminClients);const i=await fetch(S.adminClients,{headers:{Authorization:`Bearer ${l.session.access_token}`}});if(console.log("ðŸ“¡ [ClientsModule] Response status:",i.status),!i.ok)throw new Error("Backend API failed");const t=await i.json();console.log("âœ… [ClientsModule] Loaded clients from API:",((s=t.clients)==null?void 0:s.length)||0),u(t.clients||[]),N(!1)}catch{console.log("ðŸ“¦ [ClientsModule] Using direct database access..."),N(!0);const{data:t,error:j}=await g.from("kv_store_c2a25be0").select("key, value").like("key","personal_info:%");if(j)throw console.error("âŒ Error fetching from KV store:",j),new Error("Failed to load from both API and KV store");if(console.log(`ðŸ“‹ Found ${(t==null?void 0:t.length)||0} clients in KV store`),!t||t.length===0){const{data:d}=await g.from("kv_store_c2a25be0").select("key, value").like("key","onboarding_data:%");if(d&&d.length>0){const c=d.map(n=>{var m;const r=n.key.replace("onboarding_data:",""),a=n.value;return{id:r,email:(a==null?void 0:a.email)||`user-${r.substring(0,8)}@example.com`,name:(a==null?void 0:a.firstName)||((m=a==null?void 0:a.email)==null?void 0:m.split("@")[0])||"Unknown User",createdAt:new Date().toISOString(),personalInfo:a,taxFilings:[],onboardingComplete:!0}});console.log(`âœ… Loaded ${c.length} clients from onboarding_data`),u(c);return}u([]),_.info("No clients registered yet");return}const v=await Promise.all(t.map(async d=>{var C,k,A;const c=d.key.replace("personal_info:",""),n=d.value,{data:r}=await g.from("kv_store_c2a25be0").select("value").eq("key",`user_metadata:${c}`).single(),{data:a}=await g.from("kv_store_c2a25be0").select("value").like("key",`tax_filing:${c}:%`),m=((C=r==null?void 0:r.value)==null?void 0:C.email)||(n==null?void 0:n.email)||`user-${c.substring(0,8)}@example.com`,O=((k=r==null?void 0:r.value)==null?void 0:k.name)||(n==null?void 0:n.firstName)||m.split("@")[0];return{id:c,email:m,name:O,createdAt:((A=r==null?void 0:r.value)==null?void 0:A.created_at)||new Date().toISOString(),personalInfo:n,taxFilings:(a==null?void 0:a.map(U=>U.value))||[],onboardingComplete:!!n}}));console.log(`âœ… Loaded ${v.length} clients from KV store`),u(v)}}catch(l){console.error("âŒ [ClientsModule] Error loading clients:",l),_.error(`Failed to load clients: ${l instanceof Error?l.message:"Network error"}`)}finally{b(!1)}},y=h.filter(s=>{var i,t;const l=((i=s.name)==null?void 0:i.toLowerCase().includes(p.toLowerCase()))||((t=s.email)==null?void 0:t.toLowerCase().includes(p.toLowerCase())),o=f==="all"||f==="active"&&s.onboardingComplete||f==="onboarding"&&!s.onboardingComplete;return l&&o}),w=s=>{F(`/admin/clients/${s}`)};return E?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx(K,{className:"w-8 h-8 animate-spin text-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading clients..."})]})}):e.jsxs("div",{className:"space-y-6",children:[L&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center gap-2",children:[e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full animate-pulse"}),e.jsx("p",{className:"text-sm text-blue-800",children:"Using direct database access (API endpoint not responding)"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Clients"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:h.length})]}),e.jsx("div",{className:"p-3 bg-blue-50 rounded-lg",children:e.jsx(V,{className:"w-6 h-6 text-blue-600"})})]})}),e.jsx("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Active Clients"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:h.filter(s=>s.onboardingComplete).length})]}),e.jsx("div",{className:"p-3 bg-green-50 rounded-lg",children:e.jsx(M,{className:"w-6 h-6 text-green-600"})})]})}),e.jsx("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"In Onboarding"}),e.jsx("p",{className:"text-3xl font-bold text-gray-900 mt-1",children:h.filter(s=>!s.onboardingComplete).length})]}),e.jsx("div",{className:"p-3 bg-orange-50 rounded-lg",children:e.jsx(D,{className:"w-6 h-6 text-orange-600"})})]})})]}),e.jsx("div",{className:"bg-white p-6 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(R,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search by name or email...",value:p,onChange:s=>P(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsxs("select",{value:f,onChange:s=>I(s.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Clients"}),e.jsx("option",{value:"active",children:"Active Only"}),e.jsx("option",{value:"onboarding",children:"In Onboarding"})]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Client"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Contact"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Tax Filings"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Joined"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:y.length===0?e.jsx("tr",{children:e.jsxs("td",{colSpan:6,className:"px-6 py-12 text-center",children:[e.jsx(q,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"No clients found"}),p&&e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Try adjusting your search or filters"})]})}):y.map(s=>{var l,o,i,t;return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors cursor-pointer",onClick:()=>w(s.id),children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-blue-600 font-semibold text-sm",children:((o=(l=s.name)==null?void 0:l.charAt(0))==null?void 0:o.toUpperCase())||"U"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.name||"Unknown"}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(z,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate max-w-xs",children:s.email})]}),((i=s.personalInfo)==null?void 0:i.homePhoneNumber)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsxs("span",{children:["(",s.personalInfo.homePhoneArea,") ",s.personalInfo.homePhoneNumber]})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.onboardingComplete?e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Active"}):e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800",children:"Onboarding"})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-600",children:[((t=s.taxFilings)==null?void 0:t.length)||0," filing(s)"]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-600",children:new Date(s.createdAt).toLocaleDateString("en-CA",{year:"numeric",month:"short",day:"numeric"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsxs("button",{onClick:j=>{j.stopPropagation(),w(s.id)},className:"text-blue-600 hover:text-blue-900 flex items-center gap-1 ml-auto",children:["View Details",e.jsx(Z,{className:"w-4 h-4"})]})})]},s.id)})})]})})})]})}export{X as default};
